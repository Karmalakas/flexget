#
# Author: Christian Alexander <alexforsale@yahoo.com>
#
variables: secrets.yml

templates:

  global:
# semua task akan berhenti jika sisa space untuk path - path dibawah ini kurang
# dari 5000mb
    free_space:
      path: '{? media.partition ?}'
      space: 5000
    pathscrub: windows
    no_entries_ok: yes

  series:
    metainfo_series: yes
    thetvdb_lookup: yes
    nfo_lookup: yes
    parsing:
      series: guessit
    configure_series:
      settings:
        qualities:
          - hdtv <720p
        identified_by: ep
      from:
        filesystem:
          -  '{? staging.series ?}'
          -  '{? folder.series ?}'
    exists_series:
      path:
        -  '{? staging.series ?}'
        -  '{? folder.series ?}'

  transmission-global:
    _transmission-settings: &transmission-settings
      enabled: yes
      host: localhost
      port: 9091
      username: transmission
      password: transmission
      ratio: 1
      include_subs: yes
    retry_failed:
      retry_time: 10 seconds
      retry_time_multiplier: 1
      max_retries: 4

  transmission-series:
    transmission:
      <<: *transmission-settings
      main_file_only: yes
      include_subs: yes
      rename_like_files: yes
      path: '{? staging.series ?}/{{tvdb_series_name|default(series_name)|pathscrub}}/'
      content_filename: "{{tvdb_series_name|default(series_name)|pathscrub}} - {{tvdb_ep_id|default(series_id)}}{% if tvdb_ep_name|default(False) %} - {{tvdb_ep_name|pathscrub}}{% endif %}{% if quality|default(False) %} - [{{quality}}]{% endif %}"

  transmission-movies:
    transmission:
      <<: *transmission-settings
      main_file_only: yes
      include_subs: yes
      rename_like_files: yes
      content_filename: "{{tmdb_name|pathscrub}} ({{tmdb_year}}){% if quality|default(False) %} - [{{quality}}]{% endif %}"
      path: '{? staging.movies ?}/{{movie_name|pathscrub}}'

tasks:
  versioncheck:
    version_checker:
      check_for_dev_version: yes
      interval: 1

  check_existing_movies:
    filesystem:
      path:
        - '{? folder.movies ?}'
        - '{? staging.movies ?}'
      retrieve:
        - files
        - dirs
      recursive: yes
      regexp: '.*\.(avi|mkv|mp4|m4v|iso)$'
    only_new: yes
    imdb_lookup: yes
    trakt_lookup: yes
    nfo_lookup: yes
    parsing:
      movie: guessit
    list_add:
      - movie_list: existing movies

  check_existing_episodes:
    template:
      - series
    filesystem:
      path:
        - '{? folder.series ?}'
        - '{? staging.series ?}'
      retrieve:
        - files
        - dirs
      recursive: yes
      regexp: '.*\.(avi|mkv|mp4|m4v|iso)$'
    all_series: yes
    only_new: yes
    list_add:
      - entry_list: existing episodes
    set_series_begin: yes

  update_series_list:
    disable:
      - seen
    template:
      - series
    filesystem:
      path:
        - '{? folder.series ?}'
        - '{? staging.series ?}'
      retrieve: dirs
      recursive: no
    manipulate:
      - title:
          replace:
            regexp: '$'
            format: ' S01E01'
    accept_all: yes
    list_add:
      - entry_list: existing series

  discover-series:
    template:
      - series
      - transmission-series
    discover:
      what:
        - next_series_episodes: yes
      from:
        - rarbg:
            category: x264
    content_size:
      max: 900
      min: 20
